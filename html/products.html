<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1028 Tea and Cafe - Products</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./../css/dashboard.css">
    <link rel="stylesheet" href="./../css/products.css">
    <link rel="stylesheet" href="../css/global.css">
    
</head>
<body>
    <!-- Header -->
<div class="header">
    <div class="brand">
        <img src="../assets/logo.jpg" alt="Cafe Logo">
        <span>1028 Tea & Cafe</span>
    </div>

    <div class="admin-profile" id="adminProfile">
        <div class="admin-text">
            <div class="label">Welcome</div>
            <div class="name">Admin</div>
        </div>
        <button class="profile-toggle" id="profileToggle" aria-expanded="false">
            <i class="fas fa-user-circle" style="font-size: 2rem;"></i>
        </button>

        <div class="profile-dropdown" id="profileDropdown">
            <form method="post" action="../logout.php">
                <button type="submit" class="dropdown-logout">Logout</button>
            </form>
        </div>
    </div>
</div>


    <div class="main-container">
        <div class="sidebar">
            <a class="nav-item" href="dashboard.html">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dash Board</span>
            </a>
            <a class="nav-item" href="../profit.php">
                <i class="fas fa-chart-line"></i>
                <span>View Profit</span>
            </a>
            <a class="nav-item" href="expenses.html">
                <i class="fas fa-money-bill"></i>
                <span>View Expenses</span>
            </a>
            <a class="nav-item active" href="products.html">
                <i class="fas fa-box"></i>
                <span>Products</span>
            </a>
            <a class="nav-item" href="file_manager.html">
                <i class="fas fa-folder"></i>
                <span>File Manager</span>
            </a>
            <a class="nav-item" href="analytics.html">
                <i class="fas fa-chart-bar"></i>
                <span>Analytics</span>
            </a>
            <a class="nav-item" href="../logout.php">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </a>
        </div>

        <div class="content">
            <div class="content-title">Products</div>

                <!-- Categories filter: chips for desktop, select for small screens -->
                <div class="categories-wrap" style="margin-bottom:12px">
                        <div class="category-bar" id="categoryBar" role="tablist" aria-label="Product categories">
                            <!-- categories will be injected here from the database -->
                            <button class="category-chip active" data-category="all">All</button>
                        </div>

                        <select id="categorySelect" class="category-select" aria-label="Filter products by category">
                            <option value="all">All</option>
                            <!-- options will be injected here from the database -->
                        </select>
                </div>

                <div class="button-container" style="margin-bottom:12px">
                    <button class="btn-add-product">Add Product</button>
                </div>

            <div class="table-container">
                <div class="table-label">Product Catalog</div>
                <table class="product-table">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>Name</th>
                            <th>Category</th>
                            <th class="price-col">Price</th>
                            <th class="stock-col">Stock</th>
                            <th class="action-col">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productsTbody">
                        <!-- product rows will be rendered here from the database -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="script.js"></script>
        <script>
            // Products page: category filtering (chips + select)
            (function () {
                function filterByCategory(cat) {
                    const rows = document.querySelectorAll('.product-table tbody tr');
                    rows.forEach((r) => {
                        const rcat = (r.getAttribute('data-category') || '').toLowerCase();
                        if (!cat || cat === 'all') {
                            r.style.display = '';
                        } else {
                            r.style.display = (rcat === cat.toLowerCase()) ? '' : 'none';
                        }
                    });
                }

                document.addEventListener('DOMContentLoaded', function () {
                    const chips = document.querySelectorAll('.category-chip');
                    const select = document.getElementById('categorySelect');

                    if (chips && chips.length) {
                        chips.forEach((btn) => {
                            btn.addEventListener('click', function () {
                                // toggle active class
                                chips.forEach(c => c.classList.remove('active'));
                                this.classList.add('active');
                                const cat = this.getAttribute('data-category') || 'all';
                                // sync select if present
                                if (select) select.value = cat;
                                filterByCategory(cat);
                            });
                        });
                    }

                    if (select) {
                        select.addEventListener('change', function () {
                            const val = this.value || 'all';
                            // update chips
                            const targetChip = Array.from(document.querySelectorAll('.category-chip')).find(c => c.getAttribute('data-category') === val);
                            document.querySelectorAll('.category-chip').forEach(c => c.classList.remove('active'));
                            if (targetChip) targetChip.classList.add('active');
                            filterByCategory(val);
                        });
                    }
                });
            })();

            // Fetch categories and products from the server (expects endpoints that return JSON)
            (function loadData() {
                async function fetchJson(url) {
                    try {
                        const res = await fetch(url, { credentials: 'same-origin' });
                        if (!res.ok) throw new Error('Network response was not ok');
                        return await res.json();
                    } catch (e) {
                        console.error('Fetch error', url, e);
                        return null;
                    }
                }

                function renderCategories(categories) {
                    const bar = document.getElementById('categoryBar');
                    const select = document.getElementById('categorySelect');
                    if (!Array.isArray(categories)) return;
                    categories.forEach(cat => {
                        const btn = document.createElement('button');
                        btn.className = 'category-chip';
                        btn.setAttribute('data-category', cat.slug || cat.name);
                        btn.textContent = cat.name;
                        btn.addEventListener('click', function () {
                            document.querySelectorAll('.category-chip').forEach(c => c.classList.remove('active'));
                            this.classList.add('active');
                            const val = this.getAttribute('data-category') || 'all';
                            const sel = document.getElementById('categorySelect'); if (sel) sel.value = val;
                            // trigger filtering
                            const event = new Event('change'); if (sel) sel.dispatchEvent(event);
                        });
                        bar.appendChild(btn);

                        const opt = document.createElement('option');
                        opt.value = cat.slug || cat.name;
                        opt.textContent = cat.name;
                        select.appendChild(opt);
                    });
                }

                function renderProducts(products) {
                    const tbody = document.getElementById('productsTbody');
                    if (!Array.isArray(products)) return;
                    tbody.innerHTML = '';
                    products.forEach(p => {
                        const tr = document.createElement('tr');
                        tr.setAttribute('data-category', p.category_slug || p.category || '');
                        tr.innerHTML = `
                            <td>${p.sku || ''}</td>
                            <td>${p.name || ''}</td>
                            <td>${p.category || ''}</td>
                            <td class="price-col">${p.price ? 'â‚± ' + p.price : ''}</td>
                            <td class="stock-col">${p.stock != null ? p.stock : ''}</td>
                            <td class="action-col">
                                <button class="btn-view-details" data-id="${p.id || ''}">Edit</button>
                                <button class="btn-delete" data-id="${p.id || ''}">Delete</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }

                // Try to load categories then products. Endpoints are expected to return JSON arrays.
                (async function () {
                    const cats = await fetchJson('/get_categories.php');
                    if (cats && Array.isArray(cats)) renderCategories(cats);
                    const prods = await fetchJson('/get_products.php');
                    if (prods && Array.isArray(prods)) renderProducts(prods);
                })();
            })();
        </script>
</body>
</html>
