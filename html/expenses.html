<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1028 Tea and Cafe - View Expenses</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./../css/dashboard.css">
    <link rel="stylesheet" href="./../css/expenses.css">
    <link rel="stylesheet" href="../css/global.css">

</head>
<body>
    <!-- Header -->
<div class="header">
    <div class="brand">
        <img src="../assets/logo.jpg" alt="Cafe Logo">
        <span>1028 Tea & Cafe</span>
    </div>

    <div class="admin-profile" id="adminProfile">
        <div class="admin-text">
            <div class="label">Welcome</div>
            <div class="name">Admin</div>
        </div>
        <button class="profile-toggle" id="profileToggle" aria-expanded="false">
            <i class="fas fa-user-circle" style="font-size: 2rem;"></i>
        </button>

        <div class="profile-dropdown" id="profileDropdown">
            <form method="post" action="../logout.php">
                <button type="submit" class="dropdown-logout">Logout</button>
            </form>
        </div>
    </div>
</div>


    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <a class="nav-item" href="dashboard.html">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dash Board</span>
            </a>
            <a class="nav-item" href="../profit.php">
                <i class="fas fa-chart-line"></i>
                <span>View Profit</span>
            </a>
            <a class="nav-item active" href="expenses.html">
                <i class="fas fa-money-bill"></i>
                <span>View Expenses</span>
            </a>
            <a class="nav-item" href="products.html">
                <i class="fas fa-box"></i>
                <span>Products</span>
            </a>
            <a class="nav-item" href="file_manager.html">
                <i class="fas fa-folder"></i>
                <span>File Manager</span>
            </a>
            <a class="nav-item" href="analytics.html">
                <i class="fas fa-chart-bar"></i>
                <span>Analytics</span>
            </a>
            <a class="nav-item" href="../logout.php">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </a>
        </div>

        <!-- Content Area -->
        <div class="content">
            <div class="content-title">View Expenses</div>

            <div class="button-container" style="margin-bottom:12px">
                <button class="btn-add-expense btn btn-primary">Add Expense</button>
            </div>

                            <!-- Add Expense Modal -->
                            <div class="modal fade" id="addExpenseModal" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Add Expense</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <form id="addExpenseForm">
                                            <div class="modal-body">
                                                <div class="mb-3">
                                                    <label class="form-label">Date</label>
                                                    <input type="date" name="expense_date" class="form-control" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Category</label>
                                                    <input type="text" name="category" class="form-control" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Description</label>
                                                    <input type="text" name="description" class="form-control">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Amount</label>
                                                    <input type="number" step="0.01" name="amount" class="form-control" required>
                                                </div>
                                                <div id="addExpenseError" class="text-danger" style="display:none"></div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                <button type="submit" class="btn btn-primary">Save Expense</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
            <div class="table-container">
                <div class="table-label">Expenses</div>
                <table class="expense-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Category</th>
                            <th>Description</th>
                            <th class="amount-col">Amount</th>
                            <th class="action-col">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="expensesBody">
                        <!-- Rows will be loaded from the server via AJAX -->
                        <tr><td colspan="5">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const tbody = document.getElementById('expensesBody');

            function escapeHtml(unsafe) {
                return unsafe ? unsafe.replace(/[&<>\"']/g, function (m) { return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m]; }) : '';
            }

            function rowHtml(item, temporary = false) {
                const amt = Number(item.amount || 0).toLocaleString('en-PH', { style: 'currency', currency: 'PHP', maximumFractionDigits: 2 });
                const date = item.date || '';
                const desc = escapeHtml(item.description || '');
                const cat = escapeHtml(item.category || '');
                // if item.id is missing, render buttons but disable delete (can't act without id)
                const viewId = (typeof item.id !== 'undefined' && item.id !== null) ? item.id : '';
                const deleteDisabled = viewId ? '' : 'disabled';
                const tempAttr = temporary ? ' data-temp="1"' : '';
                return `\n                        <tr${tempAttr}>\n                            <td>${date}</td>\n                            <td>${cat}</td>\n                            <td>${desc}</td>\n                            <td class="amount-col">${amt}</td>\n                            <td class="action-col">\n                                <button class="btn-view-details btn btn-sm btn-outline-secondary" data-id="${viewId}">View</button>\n                                <button class="btn-delete btn btn-sm btn-outline-danger" data-id="${viewId}" ${deleteDisabled}>Delete</button>\n                            </td>\n                        </tr>`;
            }

            function renderRows(data) {
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5">No expenses found.</td></tr>';
                    return;
                }
                tbody.innerHTML = data.map(item => rowHtml(item)).join('');
            }

            function loadExpenses() {
                tbody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';
                // prefer the main endpoint but be resilient to non-JSON/errors
                const url = '../get_expenses.php?t=' + Date.now();
                fetch(url, { credentials: 'same-origin' })
                    .then(res => res.text())
                    .then(text => {
                        // try to parse JSON; if it fails show raw response to aid debugging
                        let json = null;
                        try { json = JSON.parse(text); } catch (e) {
                            console.error('get_expenses parse error, raw:', text);
                            // show raw server output (escaped) so user can see PHP errors / messages
                            tbody.innerHTML = `<tr><td colspan="5">${escapeHtml('Invalid server response: ' + text)}</td></tr>`;
                            return;
                        }

                        if (!json || !json.success) {
                            // show helpful server error messages inline
                            const msg = (json && (json.error || json.message)) ? (json.error || json.message) : 'Error loading expenses';
                            const dbErr = (json && json.db_error) ? (' DB: ' + json.db_error) : '';
                            const diag = (json && json.diagnostic) ? (' Details: ' + JSON.stringify(json.diagnostic)) : '';
                            tbody.innerHTML = `<tr><td colspan="5">${escapeHtml(msg + dbErr + diag)}</td></tr>`;
                            // if main endpoint failed, try the quick debug endpoint once to see raw table rows
                            if (!url.includes('get_expenses_quick.php')) {
                                fetch('../get_expenses_quick.php').then(r => r.text()).then(t => {
                                    try { const q = JSON.parse(t); if (q && q.success) { renderRows(q.data); return; } } catch (e) { /* ignore */ }
                                }).catch(()=>{});
                            }
                            return;
                        }

                        // success: ensure data is an array
                        const data = Array.isArray(json.data) ? json.data : [];
                        renderRows(data);
                    })
                    .catch(err => {
                        console.error(err);
                        tbody.innerHTML = '<tr><td colspan="5">Error loading expenses.</td></tr>';
                    });
            }

            // setup add modal
            const addBtn = document.querySelector('.btn-add-expense');
            const addModalEl = document.getElementById('addExpenseModal');
            // Move modal markup to document.body to avoid stacking/context issues with app layout
            if (addModalEl && addModalEl.parentElement !== document.body) {
                document.body.appendChild(addModalEl);
            }
            const addModal = new bootstrap.Modal(addModalEl);
            const addForm = document.getElementById('addExpenseForm');
            const addError = document.getElementById('addExpenseError');

            addBtn && addBtn.addEventListener('click', () => {
                addForm.reset();
                addError.style.display = 'none';
                addModal.show();
            });

            // focus first input when modal shown
            if (addModalEl) {
                addModalEl.addEventListener('shown.bs.modal', function () {
                    const first = addForm.querySelector('[name="expense_date"]');
                    if (first) first.focus();
                });
            }

            addForm && addForm.addEventListener('submit', function (ev) {
                ev.preventDefault();
                const fd = new FormData(addForm);
                fetch('../add_expense.php', { method: 'POST', body: fd, headers: { 'Accept': 'application/json' }, credentials: 'same-origin' })
                    .then(r => r.text())
                    .then(text => {
                        console.log('add_expense response text:', text);
                        let res = null;
                        try { res = JSON.parse(text); } catch (e) { res = { success: false, error: 'Invalid server response', raw: text }; }
                        if (!res.success) {
                            console.error('Add expense error response:', res);
                            let msg = res.error || 'Failed to add expense';
                            if (res.diagnostic) msg += ' (' + JSON.stringify(res.diagnostic) + ')';
                            if (res.raw) msg += ' Raw: ' + res.raw;
                            addError.textContent = msg;
                            addError.style.display = 'block';
                            return;
                        }
                        // success — if server returned the new row, prepend it for immediate feedback; otherwise reload full list
                        if (res.row) {
                            // server provided a row object (may not include an id). Show it immediately.
                            const firstRow = tbody.querySelector('tr');
                            const newHtml = rowHtml(res.row);
                            // If the table currently shows an empty message, replace it; otherwise insert at top
                            if (firstRow && firstRow.textContent.trim() === 'No expenses found.') {
                                tbody.innerHTML = newHtml;
                            } else {
                                tbody.insertAdjacentHTML('afterbegin', newHtml);
                            }
                            // mark the new row as temporary so it isn't removed if an immediate refresh fails
                            // attempt to refresh the authoritative list in the background; if refresh fails,
                            // keep the temporary row visible and retry a few times before giving up.
                            attemptReloadAfterAdd();
                        } else {
                            // fallback: reload from server
                            loadExpenses();
                        }
                        addModal.hide();
                    })
                    .catch(err => {
                        console.error('Fetch error:', err);
                        addError.textContent = 'Failed to add expense (network)';
                        addError.style.display = 'block';
                    });
            });

            // delete via delegation
            document.getElementById('expensesBody').addEventListener('click', function (ev) {
                const btn = ev.target.closest('.btn-delete');
                if (!btn) return;
                // locate the row
                const tr = btn.closest('tr');
                const id = btn.dataset.id;

                // if no id (temporary row), allow removing it locally
                if (!id) {
                    if (!confirm('This expense is not yet saved on server. Remove from list?')) return;
                    if (tr) tr.parentNode.removeChild(tr);
                    return;
                }

                if (!confirm('Delete this expense?')) return;

                fetch('../delete_expense.php', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Accept': 'application/json' }, body: 'id=' + encodeURIComponent(id), credentials: 'same-origin' })
                    .then(r => r.text())
                    .then(text => {
                        let res = null;
                        try { res = JSON.parse(text); } catch (e) { res = { success: false, error: 'Invalid server response', raw: text }; }
                        if (!res.success) {
                            console.error('Delete error response:', res);
                            alert(res.error || 'Failed to delete expense');
                            return;
                        }
                        // remove the row from the DOM
                        if (tr) tr.parentNode.removeChild(tr);
                    })
                    .catch(err => { console.error(err); alert('Failed to delete (network)'); });
            });

            // Background reload logic after adding a row: retry fetching authoritative list up to N times
            function attemptReloadAfterAdd(maxRetries = 5, delayMs = 1200) {
                let attempts = 0;
                const noticeId = 'expensesNotice';

                function showNotice(msg) {
                    let el = document.getElementById(noticeId);
                    if (!el) {
                        el = document.createElement('div');
                        el.id = noticeId;
                        el.style.margin = '8px 0';
                        el.style.color = '#b00';
                        const container = document.querySelector('.table-container') || document.body;
                        container.insertBefore(el, container.firstChild);
                    }
                    el.textContent = msg;
                }

                function clearNotice() {
                    const el = document.getElementById(noticeId);
                    if (el) el.parentNode.removeChild(el);
                }

                function tryFetch() {
                    attempts++;
                    fetch('../get_expenses.php?t=' + Date.now(), { credentials: 'same-origin' })
                        .then(r => r.json())
                        .then(json => {
                            if (json && json.success && Array.isArray(json.data)) {
                                // replace table with authoritative data
                                clearNotice();
                                renderRows(json.data);
                                return;
                            }
                            // failed to get authoritative list
                            if (attempts < maxRetries) {
                                showNotice('Saved locally — retrying to fetch server list... (attempt ' + (attempts+1) + ')');
                                setTimeout(tryFetch, delayMs);
                            } else {
                                showNotice('Saved locally — could not refresh server list.');
                            }
                        })
                        .catch(err => {
                            console.error('attemptReloadAfterAdd fetch error', err);
                            if (attempts < maxRetries) {
                                showNotice('Saved locally — retrying to fetch server list... (attempt ' + (attempts+1) + ')');
                                setTimeout(tryFetch, delayMs);
                            } else {
                                showNotice('Saved locally — could not refresh server list.');
                            }
                        });
                }

                // start first attempt after a short delay so DB has a moment to commit
                setTimeout(tryFetch, delayMs);
            }

            // initial load
            loadExpenses();
        });
    </script>
</body>
</html>
